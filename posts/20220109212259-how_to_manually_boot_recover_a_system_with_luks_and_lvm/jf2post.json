{"author":{"name":"Albert","type":"card","url":"https://albertdelafuente.com"},"content":{"html":"\n\n\u003cp\u003eI have been using LVM on top of LUKS for more than 2 years without problems.\nHowever since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in\nthe past I was quite concerned of what would happen when I would have problems.\nToday my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This\npost shows the steps I performed to recover my system.\u003c/p\u003e\n\n\u003cp\u003eI use Arch Linux and I prepared a repository with my custom install method\nbased on archinstaller. Basically I have a custom partitioning based on LVM on\ntop of LUKS and some variables to start he installing method.\u003c/p\u003e\n\n\u003cp\u003eHere is an overview of the parts on this tutorial:\u003c/p\u003e\n\n\u003ch2 id=\"tutorial-overview\"\u003eTutorial overview\u003c/h2\u003e\n\n\u003col\u003e\n\u003cli\u003eCreate a bootable USB and boot the broken system with it (AKA recovery mode**\u003c/li\u003e\n\u003cli\u003eChroot into the system\u003c/li\u003e\n\u003cli\u003eFix the issue\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"assumptions\"\u003eAssumptions\u003c/h2\u003e\n\n\u003cp\u003eI will assume that the error is similar as mine. After opening the LUKS device,\nI had the following problem:\n\u003ccode\u003eERROR: device /dev/mapper/storage-root not found\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"create-a-bootable-usb\"\u003eCreate a bootable USB\u003c/h2\u003e\n\n\u003cp\u003eTo create a bootable USB you need to download the latest Arch Linux iso and\nthen us \u003ccode\u003edd\u003c/code\u003e to dump it to a flash drive.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003edd \u003cspan class=\"nv\"\u003ebs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4M \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/path/to/archlinux.iso \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/sdx \u003cspan class=\"nv\"\u003estatus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eprogress \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e sync\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter completion, use the same flash drive to boot the broken computer. You\ngenerally need to hit a key on the \u003ccode\u003eF5\u003c/code\u003e - \u003ccode\u003eF6\u003c/code\u003e range to choose the boot method.\u003c/p\u003e\n\n\u003ch2 id=\"chroot-into-the-system\"\u003eChroot into the system\u003c/h2\u003e\n\n\u003cp\u003eOnce the system has booted, now we need to mount everything the system would\nmount on a boot stage.  Adapt the LUKS label and LVM devices according to your\nneeds.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"c1\"\u003e# Open the LUKS device.\u003c/span\u003e\ncryptsetup luksOpen /dev/disk/by-partlabel/cryptlvm lvm\n\n\u003cspan class=\"c1\"\u003e# Mount the root partition\u003c/span\u003e\nmount /dev/storage/root /mnt\n\n\u003cspan class=\"c1\"\u003e# Mount the boot partition\u003c/span\u003e\nmount /dev/sda1 /mnt/boot\n\n\u003cspan class=\"c1\"\u003e# Mount proc, sys and dev\u003c/span\u003e\nmount -t proc proc proc/\nmount -t sysfs sys sys/\nmount -o \u003cspan class=\"nb\"\u003ebind\u003c/span\u003e /dev dev/\n\n\u003cspan class=\"c1\"\u003e# Switch to bash\u003c/span\u003e\nbash\n\n\u003cspan class=\"c1\"\u003e# Chroot\u003c/span\u003e\nchroot /mnt\n\n\u003cspan class=\"c1\"\u003e# Bring up network if needed\u003c/span\u003e\ndhcpcd eth0\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAt this point you should have shell with a recovery environment set to fix the\nissue, so let\u0026rsquo;s fix it.\u003c/p\u003e\n\n\u003ch2 id=\"fix-the-issue\"\u003eFix the issue\u003c/h2\u003e\n\n\u003cp\u003eTo fix the issue we basically are going to perform an upgrade an recreate the\ninitial ramdisk\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"c1\"\u003e# Update the packages database\u003c/span\u003e\npacman -Syy\n\n\u003cspan class=\"c1\"\u003e# Upgrade the packages\u003c/span\u003e\npacman -Syu\n\n\u003cspan class=\"c1\"\u003e# Update udev package\u003c/span\u003e\npacman -S udev\n\n\u003cspan class=\"c1\"\u003e# Update mkinitcpio package\u003c/span\u003e\npacman -S mkinitcpio\n\n\u003cspan class=\"c1\"\u003e# Recreate the initial ramdisk\u003c/span\u003e\nmkinitcpio -p linux\n\n\u003cspan class=\"c1\"\u003e# Exit the chroot environment\u003c/span\u003e\n\u003cspan class=\"nb\"\u003eexit\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Reboot\u003c/span\u003e\nreboot\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf everything went well, you now should be able to boot the system properly.\u003c/p\u003e\n\n\u003ch2 id=\"conclusions\"\u003eConclusions\u003c/h2\u003e\n\n\u003cp\u003eI was quite worried about how to solve this issue due to the several layers of\ncomplexity: GPT, LUKS and LVM, however everything went out quite smoothly. The\nkey part is to use a USB flash drive and then mount the boot and root\npartitions to recreate the ramdisk.\u003c/p\u003e\n\n\u003cp\u003eThanks for reading. Spot an error or want to explain something better, feel\nfree to send me a PR.\u003c/p\u003e\n","text":" I have been using LVM on top of LUKS for more than 2 years without problems. However since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in the past I was quite concerned of what would happen when I would have problems. Today my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This post shows the steps I performed to recover my system.\nI use Arch Linux and I prepared a repository with my custom install method based on archinstaller. Basically I have a custom partitioning based on LVM on top of LUKS and some variables to start he installing method.\nHere is an overview of the parts on this tutorial:\nTutorial overview  Create a bootable USB and boot the broken system with it (AKA recovery mode** Chroot into the system Fix the issue  Assumptions I will assume that the error is similar as mine. After opening the LUKS device, I had the following problem: ERROR: device /dev/mapper/storage-root not found.\nCreate a bootable USB To create a bootable USB you need to download the latest Arch Linux iso and then us dd to dump it to a flash drive.\ndd bs=4M if=/path/to/archlinux.iso of=/dev/sdx status=progress \u0026amp;\u0026amp; sync After completion, use the same flash drive to boot the broken computer. You generally need to hit a key on the F5 - F6 range to choose the boot method.\nChroot into the system Once the system has booted, now we need to mount everything the system would mount on a boot stage. Adapt the LUKS label and LVM devices according to your needs.\n# Open the LUKS device. cryptsetup luksOpen /dev/disk/by-partlabel/cryptlvm lvm # Mount the root partition mount /dev/storage/root /mnt # Mount the boot partition mount /dev/sda1 /mnt/boot # Mount proc, sys and dev mount -t proc proc proc/ mount -t sysfs sys sys/ mount -o bind /dev dev/ # Switch to bash bash # Chroot chroot /mnt # Bring up network if needed dhcpcd eth0 At this point you should have shell with a recovery environment set to fix the issue, so let\u0026rsquo;s fix it.\nFix the issue To fix the issue we basically are going to perform an upgrade an recreate the initial ramdisk\n# Update the packages database pacman -Syy # Upgrade the packages pacman -Syu # Update udev package pacman -S udev # Update mkinitcpio package pacman -S mkinitcpio # Recreate the initial ramdisk mkinitcpio -p linux # Exit the chroot environment exit # Reboot reboot If everything went well, you now should be able to boot the system properly.\nConclusions I was quite worried about how to solve this issue due to the several layers of complexity: GPT, LUKS and LVM, however everything went out quite smoothly. The key part is to use a USB flash drive and then mount the boot and root partitions to recreate the ramdisk.\nThanks for reading. Spot an error or want to explain something better, feel free to send me a PR.\n"},"name":"How to manually boot/recover a system with LUKS and LVM","published":"2016-11-22T00:00:00-02:00","summary":"I have been using LVM on top of LUKS for more than 2 years without problems. However since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in the past I was quite concerned of what would happen when I would have problems. Today my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This post shows the steps I performed to recover my system.\nI use Arch Linux and I prepared a repository with my custom install method based on archinstaller.","type":"entry","url":"https://albertdelafuente.com/posts/20220109212259-how_to_manually_boot_recover_a_system_with_luks_and_lvm/"}