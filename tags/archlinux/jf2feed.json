{"author":{"name":"Albert","type":"card","url":"https://albertdelafuente.com"},"children":[{"content":{"html":"\n\n\u003cdiv class=\"ox-hugo-toc toc\"\u003e\n\n\u003cdiv class=\"heading\"\u003eTable of Contents\u003c/div\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#optional--create-a-boot-flash-disk-using-android\"\u003e(OPTIONAL) Create a boot flash disk using android\u003c/a\u003e\n    - \u003ca href=\"#etchdroid-usb-writer-f-droid-free-and-open-source-android-app-repository\"\u003eEtchDroid USB writer | F-Droid - Free and Open Source Android App Repository\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#mounting-and-chrooting-the-system\"\u003eMounting and chrooting the system\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#edit-the-etc-default-grub-file\"\u003eEdit the /etc/default/grub file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#config-and-install-grub-and-create-the-ramdisk\"\u003eConfig and install GRUB and create the ramdisk\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#references\"\u003eReferences\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#solved-grub-with-lvm-on-luks-rescue-mode-dot-incomplete-grub-dot-cfg-installation-arch-linux-forums\"\u003e[SOLVED] Grub with lvm on LUKS -\u0026gt; rescue mode. Incomplete grub.cfg? / Installation / Arch Linux Forums\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003c/div\u003e\n\u003c!--endtoc--\u003e\u003c/p\u003e\n\n\u003cp\u003eRecently an upgrade on my notebook went bad and broke something. I wasn\u0026rsquo;t sure\nwhat went wrong but since I had just one system at that time, I had to figure\nout how to fix it with the help of my phone. Basically what I did is install\nEtchDroid to be able to download an iso and flash it to a flash drive on my\nphone directly. Later I could boot form that flash drive, mount the LUKS/LVM\npartitions and fix the bootloader. Here is a short how to.\u003c/p\u003e\n\n\u003ch2 id=\"optional--create-a-boot-flash-disk-using-android\"\u003e(OPTIONAL) Create a boot flash disk using android\u003c/h2\u003e\n\n\u003ch4 id=\"etchdroid-usb-writer-f-droid-free-and-open-source-android-app-repository\"\u003e\u003ca href=\"https://f-droid.org/en/packages/eu.depau.etchdroid/\"\u003eEtchDroid USB writer | F-Droid - Free and Open Source Android App Repository\u003c/a\u003e\u003c/h4\u003e\n\n\u003cul\u003e\n\u003cli\u003eSource: \u003ca href=\"https://f-droid.org/en/packages/eu.depau.etchdroid/\"\u003ehttps://f-droid.org/en/packages/eu.depau.etchdroid/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eTitle: EtchDroid USB writer | F-Droid - Free and Open Source Android App Repository\u003c/li\u003e\n\u003cli\u003eCaptured on: \u003cspan class=\"timestamp-wrapper\"\u003e\u003cspan class=\"timestamp\"\u003e[2021-08-05 Thu]\u003c/span\u003e\u003c/span\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"mounting-and-chrooting-the-system\"\u003eMounting and chrooting the system\u003c/h2\u003e\n\n\u003cp\u003e#+begin_src sh\u003c/p\u003e\n\n\u003cp\u003ecryptsetup luksOpen /dev/disk/by-partlabel/cryptlvm lvm\u003c/p\u003e\n\n\u003cp\u003emount /dev/storage/root /mnt\nmount /dev/storage/home /mnt/home\u003c/p\u003e\n\n\u003cp\u003emount /dev/sda1 /mnt/boot\u003c/p\u003e\n\n\u003cp\u003ecd \u003cem\u003emnt\nmount -t proc /proc proc\u003c/em\u003e\n#mount -t sysfs \u003cem\u003esys sys\u003c/em\u003e\n#mount -o bind \u003cem\u003edev dev\u003c/em\u003e\nmount -o bind \u003cem\u003erun run\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003earch-chroot /mnt\u003c/p\u003e\n\n\u003cp\u003edhcpcd eth0\n#+end_src sh\u003c/p\u003e\n\n\u003ch2 id=\"edit-the-etc-default-grub-file\"\u003eEdit the /etc/default/grub file\u003c/h2\u003e\n\n\u003cp\u003e#+begin_src sh\u003c/p\u003e\n\n\u003cp\u003eGRUB_CMDLINE_LINUX=\u0026ldquo;cryptdevice=/dev/sda2:lvm\u0026rdquo;\n  GRUB_PRELOAD_MODULES=\u0026ldquo;part_gpt part_msdos cryptodisk luks\u0026rdquo;\n#+end_src sh\u003c/p\u003e\n\n\u003ch2 id=\"config-and-install-grub-and-create-the-ramdisk\"\u003eConfig and install GRUB and create the ramdisk\u003c/h2\u003e\n\n\u003cp\u003e#+begin_src sh\u003c/p\u003e\n\n\u003cp\u003egrub-mkconfig \u0026gt; /boot/grub/grub.cfg\ngrub-install \u0026ndash;efi-directory=/boot \u0026ndash;target=x86_64-efi /dev/sda\u003c/p\u003e\n\n\u003cp\u003emkinitcpio -p linux\n#+end_src sh\u003c/p\u003e\n\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\n\u003ch3 id=\"solved-grub-with-lvm-on-luks-rescue-mode-dot-incomplete-grub-dot-cfg-installation-arch-linux-forums\"\u003e\u003ca href=\"https://bbs.archlinux.org/viewtopic.php?id=246628\"\u003e[SOLVED] Grub with lvm on LUKS -\u0026gt; rescue mode. Incomplete grub.cfg? / Installation / Arch Linux Forums\u003c/a\u003e\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eSource: \u003ca href=\"https://bbs.archlinux.org/viewtopic.php?id=246628\"\u003ehttps://bbs.archlinux.org/viewtopic.php?id=246628\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eTitle: [SOLVED] Grub with lvm on LUKS -\u0026gt; rescue mode. Incomplete grub.cfg? / Installation / Arch Linux Forums\u003c/li\u003e\n\u003cli\u003eCaptured on: \u003cspan class=\"timestamp-wrapper\"\u003e\u003cspan class=\"timestamp\"\u003e[2021-08-04 Wed]\u003c/span\u003e\u003c/span\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","text":" Table of Contents  (OPTIONAL) Create a boot flash disk using android - EtchDroid USB writer | F-Droid - Free and Open Source Android App Repository Mounting and chrooting the system Edit the /etc/default/grub file Config and install GRUB and create the ramdisk References  [SOLVED] Grub with lvm on LUKS -\u0026gt; rescue mode. Incomplete grub.cfg? / Installation / Arch Linux Forums    \nRecently an upgrade on my notebook went bad and broke something. I wasn\u0026rsquo;t sure what went wrong but since I had just one system at that time, I had to figure out how to fix it with the help of my phone. Basically what I did is install EtchDroid to be able to download an iso and flash it to a flash drive on my phone directly. Later I could boot form that flash drive, mount the LUKS/LVM partitions and fix the bootloader. Here is a short how to.\n(OPTIONAL) Create a boot flash disk using android EtchDroid USB writer | F-Droid - Free and Open Source Android App Repository  Source: https://f-droid.org/en/packages/eu.depau.etchdroid/ Title: EtchDroid USB writer | F-Droid - Free and Open Source Android App Repository Captured on: [2021-08-05 Thu]  Mounting and chrooting the system #+begin_src sh\ncryptsetup luksOpen /dev/disk/by-partlabel/cryptlvm lvm\nmount /dev/storage/root /mnt mount /dev/storage/home /mnt/home\nmount /dev/sda1 /mnt/boot\ncd mnt mount -t proc /proc proc #mount -t sysfs sys sys #mount -o bind dev dev mount -o bind run run\narch-chroot /mnt\ndhcpcd eth0 #+end_src sh\nEdit the /etc/default/grub file #+begin_src sh\nGRUB_CMDLINE_LINUX=\u0026ldquo;cryptdevice=/dev/sda2:lvm\u0026rdquo; GRUB_PRELOAD_MODULES=\u0026ldquo;part_gpt part_msdos cryptodisk luks\u0026rdquo; #+end_src sh\nConfig and install GRUB and create the ramdisk #+begin_src sh\ngrub-mkconfig \u0026gt; /boot/grub/grub.cfg grub-install \u0026ndash;efi-directory=/boot \u0026ndash;target=x86_64-efi /dev/sda\nmkinitcpio -p linux #+end_src sh\nReferences [SOLVED] Grub with lvm on LUKS -\u0026gt; rescue mode. Incomplete grub.cfg? / Installation / Arch Linux Forums  Source: https://bbs.archlinux.org/viewtopic.php?id=246628 Title: [SOLVED] Grub with lvm on LUKS -\u0026gt; rescue mode. Incomplete grub.cfg? / Installation / Arch Linux Forums Captured on: [2021-08-04 Wed]  "},"name":"How to recover a GRUB bootloader on a filesystem with LUKS and LVM","published":"2021-08-04T00:00:00-03:00","summary":"Table of Contents  (OPTIONAL) Create a boot flash disk using android - EtchDroid USB writer | F-Droid - Free and Open Source Android App Repository Mounting and chrooting the system Edit the /etc/default/grub file Config and install GRUB and create the ramdisk References  [SOLVED] Grub with lvm on LUKS -\u0026gt; rescue mode. Incomplete grub.cfg? / Installation / Arch Linux Forums    \nRecently an upgrade on my notebook went bad and broke something.","type":"entry","url":"https://albertdelafuente.com/posts/20210804193727-how_to_recover_grub_with_luks_and_lvm/"},{"content":{"html":"\n\n\u003cp\u003eI have been using LVM on top of LUKS for more than 2 years without problems.\nHowever since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in\nthe past I was quite concerned of what would happen when I would have problems.\nToday my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This\npost shows the steps I performed to recover my system.\u003c/p\u003e\n\n\u003cp\u003eI use Arch Linux and I prepared a repository with my custom install method\nbased on archinstaller. Basically I have a custom partitioning based on LVM on\ntop of LUKS and some variables to start he installing method.\u003c/p\u003e\n\n\u003cp\u003eHere is an overview of the parts on this tutorial:\u003c/p\u003e\n\n\u003ch2 id=\"tutorial-overview\"\u003eTutorial overview\u003c/h2\u003e\n\n\u003col\u003e\n\u003cli\u003eCreate a bootable USB and boot the broken system with it (AKA recovery mode**\u003c/li\u003e\n\u003cli\u003eChroot into the system\u003c/li\u003e\n\u003cli\u003eFix the issue\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"assumptions\"\u003eAssumptions\u003c/h2\u003e\n\n\u003cp\u003eI will assume that the error is similar as mine. After opening the LUKS device,\nI had the following problem:\n\u003ccode\u003eERROR: device /dev/mapper/storage-root not found\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"create-a-bootable-usb\"\u003eCreate a bootable USB\u003c/h2\u003e\n\n\u003cp\u003eTo create a bootable USB you need to download the latest Arch Linux iso and\nthen us \u003ccode\u003edd\u003c/code\u003e to dump it to a flash drive.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003edd \u003cspan class=\"nv\"\u003ebs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4M \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/path/to/archlinux.iso \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/sdx \u003cspan class=\"nv\"\u003estatus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eprogress \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e sync\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter completion, use the same flash drive to boot the broken computer. You\ngenerally need to hit a key on the \u003ccode\u003eF5\u003c/code\u003e - \u003ccode\u003eF6\u003c/code\u003e range to choose the boot method.\u003c/p\u003e\n\n\u003ch2 id=\"chroot-into-the-system\"\u003eChroot into the system\u003c/h2\u003e\n\n\u003cp\u003eOnce the system has booted, now we need to mount everything the system would\nmount on a boot stage.  Adapt the LUKS label and LVM devices according to your\nneeds.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"c1\"\u003e# Open the LUKS device.\u003c/span\u003e\ncryptsetup luksOpen /dev/disk/by-partlabel/cryptlvm lvm\n\n\u003cspan class=\"c1\"\u003e# Mount the root partition\u003c/span\u003e\nmount /dev/storage/root /mnt\n\n\u003cspan class=\"c1\"\u003e# Mount the boot partition\u003c/span\u003e\nmount /dev/sda1 /mnt/boot\n\n\u003cspan class=\"c1\"\u003e# Mount proc, sys and dev\u003c/span\u003e\nmount -t proc proc proc/\nmount -t sysfs sys sys/\nmount -o \u003cspan class=\"nb\"\u003ebind\u003c/span\u003e /dev dev/\n\n\u003cspan class=\"c1\"\u003e# Switch to bash\u003c/span\u003e\nbash\n\n\u003cspan class=\"c1\"\u003e# Chroot\u003c/span\u003e\nchroot /mnt\n\n\u003cspan class=\"c1\"\u003e# Bring up network if needed\u003c/span\u003e\ndhcpcd eth0\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAt this point you should have shell with a recovery environment set to fix the\nissue, so let\u0026rsquo;s fix it.\u003c/p\u003e\n\n\u003ch2 id=\"fix-the-issue\"\u003eFix the issue\u003c/h2\u003e\n\n\u003cp\u003eTo fix the issue we basically are going to perform an upgrade an recreate the\ninitial ramdisk\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"c1\"\u003e# Update the packages database\u003c/span\u003e\npacman -Syy\n\n\u003cspan class=\"c1\"\u003e# Upgrade the packages\u003c/span\u003e\npacman -Syu\n\n\u003cspan class=\"c1\"\u003e# Update udev package\u003c/span\u003e\npacman -S udev\n\n\u003cspan class=\"c1\"\u003e# Update mkinitcpio package\u003c/span\u003e\npacman -S mkinitcpio\n\n\u003cspan class=\"c1\"\u003e# Recreate the initial ramdisk\u003c/span\u003e\nmkinitcpio -p linux\n\n\u003cspan class=\"c1\"\u003e# Exit the chroot environment\u003c/span\u003e\n\u003cspan class=\"nb\"\u003eexit\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Reboot\u003c/span\u003e\nreboot\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf everything went well, you now should be able to boot the system properly.\u003c/p\u003e\n\n\u003ch2 id=\"conclusions\"\u003eConclusions\u003c/h2\u003e\n\n\u003cp\u003eI was quite worried about how to solve this issue due to the several layers of\ncomplexity: GPT, LUKS and LVM, however everything went out quite smoothly. The\nkey part is to use a USB flash drive and then mount the boot and root\npartitions to recreate the ramdisk.\u003c/p\u003e\n\n\u003cp\u003eThanks for reading. Spot an error or want to explain something better, feel\nfree to send me a PR.\u003c/p\u003e\n","text":" I have been using LVM on top of LUKS for more than 2 years without problems. However since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in the past I was quite concerned of what would happen when I would have problems. Today my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This post shows the steps I performed to recover my system.\nI use Arch Linux and I prepared a repository with my custom install method based on archinstaller. Basically I have a custom partitioning based on LVM on top of LUKS and some variables to start he installing method.\nHere is an overview of the parts on this tutorial:\nTutorial overview  Create a bootable USB and boot the broken system with it (AKA recovery mode** Chroot into the system Fix the issue  Assumptions I will assume that the error is similar as mine. After opening the LUKS device, I had the following problem: ERROR: device /dev/mapper/storage-root not found.\nCreate a bootable USB To create a bootable USB you need to download the latest Arch Linux iso and then us dd to dump it to a flash drive.\ndd bs=4M if=/path/to/archlinux.iso of=/dev/sdx status=progress \u0026amp;\u0026amp; sync After completion, use the same flash drive to boot the broken computer. You generally need to hit a key on the F5 - F6 range to choose the boot method.\nChroot into the system Once the system has booted, now we need to mount everything the system would mount on a boot stage. Adapt the LUKS label and LVM devices according to your needs.\n# Open the LUKS device. cryptsetup luksOpen /dev/disk/by-partlabel/cryptlvm lvm # Mount the root partition mount /dev/storage/root /mnt # Mount the boot partition mount /dev/sda1 /mnt/boot # Mount proc, sys and dev mount -t proc proc proc/ mount -t sysfs sys sys/ mount -o bind /dev dev/ # Switch to bash bash # Chroot chroot /mnt # Bring up network if needed dhcpcd eth0 At this point you should have shell with a recovery environment set to fix the issue, so let\u0026rsquo;s fix it.\nFix the issue To fix the issue we basically are going to perform an upgrade an recreate the initial ramdisk\n# Update the packages database pacman -Syy # Upgrade the packages pacman -Syu # Update udev package pacman -S udev # Update mkinitcpio package pacman -S mkinitcpio # Recreate the initial ramdisk mkinitcpio -p linux # Exit the chroot environment exit # Reboot reboot If everything went well, you now should be able to boot the system properly.\nConclusions I was quite worried about how to solve this issue due to the several layers of complexity: GPT, LUKS and LVM, however everything went out quite smoothly. The key part is to use a USB flash drive and then mount the boot and root partitions to recreate the ramdisk.\nThanks for reading. Spot an error or want to explain something better, feel free to send me a PR.\n"},"name":"How to manually boot/recover a system with LUKS and LVM","published":"2016-11-22T00:00:00-02:00","summary":"I have been using LVM on top of LUKS for more than 2 years without problems. However since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in the past I was quite concerned of what would happen when I would have problems. Today my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This post shows the steps I performed to recover my system.\nI use Arch Linux and I prepared a repository with my custom install method based on archinstaller.","type":"entry","url":"https://albertdelafuente.com/posts/20220109212259-how_to_manually_boot_recover_a_system_with_luks_and_lvm/"},{"content":{"html":"\n\n\u003ch2 id=\"how-to-manually-boot-recover-a-system-with-luks-and-lvm\"\u003eHow to manually boot/recover a system with LUKS and LVM\u003c/h2\u003e\n\n\u003cp\u003eI have been using LVM on top of LUKS for more than 2 years without problems. However since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in the past I was quite concerned of what would happen when I would have problems. Today my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This post shows the steps I performed to recover my system.\u003c/p\u003e\n\n\u003ch3 id=\"intro\"\u003eIntro\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003ecryptsetup luksOpen /dev/sda2 cryptlvm\n\ne2fsck -f /dev/mapper/storage-home\n\nresize2fs -p /dev/mapper/storage-home 200g\n\ne2fsck -f /dev/mapper/storage-home\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003elvdisplay\u003cspan class=\"o\"\u003e)\u003c/span\u003e\nlvreduce -L -15.68G /dev/storage/home\n\u003cspan class=\"o\"\u003e(\u003c/span\u003elvdisplay\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e[\u003c/span\u003elvresize -l +100%FREE /dev/storate/root\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\ne2fsck -f /dev/mapper/storage-root\n\nresize2fs /dev/mapper/storage-root\n\ncryptsetup luksClose /dev/sda2 cryptlvm\n\n\n\u003cspan class=\"c1\"\u003e### NOT NEEDED\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003epvdisplay\u003cspan class=\"o\"\u003e)\u003c/span\u003e\npvresize --sephysicalvolumesize 218G /dev/mapper/cryptlvm\n\n/dev/mapper/cryptlvm is active and is in use\n  type:    LUKS1\n  cipher:  aes-xts-plain64\n  keysize: \u003cspan class=\"m\"\u003e256\u003c/span\u003e bits\n  device:  /dev/sda2\n  offset:  \u003cspan class=\"m\"\u003e4096\u003c/span\u003e sectors\n  size:    \u003cspan class=\"m\"\u003e487981391\u003c/span\u003e sectors\n  mode:    read/write\n\n\u003cspan class=\"nv\"\u003eNEW_SECTORS\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e EXISTING_SECTORS * NEW_SIZE_IN_GB / EXISTING_SIZE_IN_GB\n\u003cspan class=\"m\"\u003e487981391\u003c/span\u003e * \u003cspan class=\"m\"\u003e200\u003c/span\u003e.7 / \u003cspan class=\"m\"\u003e232\u003c/span\u003e.7   \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e420876085\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e487981391\u003c/span\u003e - \u003cspan class=\"m\"\u003e15\u003c/span\u003e*1024*1024*2 \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e456524111\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\ncryptsetup -b \u003cspan class=\"m\"\u003e420876085\u003c/span\u003e resize cryptlvm\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecryptsetup status cryptlvm\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\nparted /dev/sda\n\nresize\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","text":" How to manually boot/recover a system with LUKS and LVM I have been using LVM on top of LUKS for more than 2 years without problems. However since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in the past I was quite concerned of what would happen when I would have problems. Today my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This post shows the steps I performed to recover my system.\nIntro cryptsetup luksOpen /dev/sda2 cryptlvm e2fsck -f /dev/mapper/storage-home resize2fs -p /dev/mapper/storage-home 200g e2fsck -f /dev/mapper/storage-home (lvdisplay) lvreduce -L -15.68G /dev/storage/home (lvdisplay) [lvresize -l +100%FREE /dev/storate/root] e2fsck -f /dev/mapper/storage-root resize2fs /dev/mapper/storage-root cryptsetup luksClose /dev/sda2 cryptlvm ### NOT NEEDED (pvdisplay) pvresize --sephysicalvolumesize 218G /dev/mapper/cryptlvm /dev/mapper/cryptlvm is active and is in use type: LUKS1 cipher: aes-xts-plain64 keysize: 256 bits device: /dev/sda2 offset: 4096 sectors size: 487981391 sectors mode: read/write NEW_SECTORS = EXISTING_SECTORS * NEW_SIZE_IN_GB / EXISTING_SIZE_IN_GB 487981391 * 200.7 / 232.7 = 420876085 (487981391 - 15*1024*1024*2 = 456524111) cryptsetup -b 420876085 resize cryptlvm (cryptsetup status cryptlvm) parted /dev/sda resize"},"name":"Resizing lvm on luks","published":"2015-11-01T00:00:00-02:00","summary":"How to manually boot/recover a system with LUKS and LVM I have been using LVM on top of LUKS for more than 2 years without problems. However since I haven\u0026rsquo;t had the chance to troubleshoot these technologies in the past I was quite concerned of what would happen when I would have problems. Today my main computer didn\u0026rsquo;t boot up and I had to fix it manually. This post shows the steps I performed to recover my system.","type":"entry","url":"https://albertdelafuente.com/posts/20220109211911-resizing_lvm_on_luks/"},{"content":{"html":"\n\n\u003cp\u003eOn this post I will show how to configure and use \u003ccode\u003ePacserve\u003c/code\u003e and \u003ccode\u003ePowerpill\u003c/code\u003e on\nArch Linux. On a network of several Arch Linux boxes, it is possible to\nconfigure a \u003ccode\u003eMaster\u003c/code\u003e server which will hold a copy of all the installed packages\nwithin that host and keep it up to date frequently.  The other hosts on the\nnetwork can be configured as \u003ccode\u003eSlaves\u003c/code\u003e and they will download the packages from\nthe Master whenever possible instead of the Internet directly. The objective is\nto save bandwidth and time when using the package manager.\u003c/p\u003e\n\n\u003ch2 id=\"configuring-pacserve-and-powerpill-on-arch-linux\"\u003eConfiguring Pacserve and Powerpill on Arch Linux\u003c/h2\u003e\n\n\u003cp\u003eThe documentation of \u003ca href=\"https://xyne.dev/projects/pacserve/\"\u003ePacserve\u003c/a\u003e explains how it works. This image summarizes\nwell the behavior.\u003c/p\u003e\n\n\n\n\n\u003cfigure\u003e\n    \n        \u003cimg src=\"https://albertdelafuente.com/ox-hugo/Pacserve_Request_Flow_Chart.svg\"/\u003e \u003c/figure\u003e\n\n\n\u003cp\u003ePacserve by itself seems very interesting however I could not make it work\nproperly. I think it has something to do my router UDP multicast forwarding\nsupport (see \u003ca href=\"http://wiki.openwrt.org/doc/recipes/dumbap\u0026gt;\"\u003eopenwrt-multicast\u003c/a\u003e). Nevertheless, I could use it within\n\u003ca href=\"http://xyne.archlinux.ca/projects/powerpill/\u0026gt;\"\u003ePowerpill\u003c/a\u003e which is a pacman wrapper to allow parallel and segmented downloads\nthrough \u003ca href=\"http://aria2.sourceforge.net/\u0026gt;\"\u003eAria2\u003c/a\u003e and \u003ca href=\"http://xyne.archlinux.ca/projects/reflector/\u0026gt;\"\u003eReflector\u003c/a\u003e.  This combo sounds even better, so I will focus on\nhow to install and use the tree tools together.\u003c/p\u003e\n\n\u003ch3 id=\"installation\"\u003eInstallation\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"c1\"\u003e# Just in case the testdb does not exists\u003c/span\u003e\ngpg --list-key\n\n\u003cspan class=\"c1\"\u003e# Receive xyne gpg key\u003c/span\u003e\ngpg --recv-keys 1D1F0DC78F173680\n\n\u003cspan class=\"c1\"\u003e# Install the packages\u003c/span\u003e\nyaourt -Sy --noconfirm reflector pacserve powerpill\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"starting-the-services--both-the-master-and-slaves--host--s\"\u003eStarting the services (both the Master and Slave(s) host(s))\u003c/h3\u003e\n\n\u003cp\u003eAfter everything is installed:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"c1\"\u003e# Enable opening the ports\u003c/span\u003e\nsudo systemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e pacserve-ports.service\n\n\u003cspan class=\"c1\"\u003e# Enable pacserve\u003c/span\u003e\nsudo systemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e pacserve.service\n\n\u003cspan class=\"c1\"\u003e# Start pacserve\u003c/span\u003e\nsudo systemctl start pacserve.service\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFor troubleshooting purposes the services can be started manually. See the\nTroubleshooting section if you have problems.\u003c/p\u003e\n\n\u003ch3 id=\"configuring-powerpill-to-use-the-master-server--slaves--hosts-only\"\u003eConfiguring Powerpill to use the Master server (Slave(s) hosts only)\u003c/h3\u003e\n\n\u003cp\u003eEdit the file \u003ccode\u003e/etc/powerpill/powerpill.json\u003c/code\u003e to include the `pacserve`.`serve`\nattribute:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-json\" data-lang=\"json\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026#34;aria2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;args\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--allow-overwrite=true\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--always-resume=false\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--auto-file-renaming=false\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--check-integrity=true\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--conditional-get=true\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--continue=true\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--file-allocation=none\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--log-level=error\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--max-concurrent-downloads=100\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--max-connection-per-server=5\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--min-split-size=5M\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--remote-time=true\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--show-console-readout=true\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e],\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;path\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/usr/bin/aria2c\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026#34;pacman\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;config\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/etc/pacman.conf\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;path\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/usr/bin/pacman\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026#34;pacserve\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;server\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;http://192.168.56.6:15678\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026#34;powerpill\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;ask\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;reflect databases\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026#34;reflector\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;args.unused\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--protocol\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;http\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--latest\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;50\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026#34;rsync\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;args\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--no-motd\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;--progress\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e],\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;db only\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;path\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/usr/bin/rsync\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026#34;servers\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIn this example I configured two VMs using Vagrant with an internal network.\nThe server runs on \u003ccode\u003e192.168.56.6\u003c/code\u003e on port `15678` (default port).\u003c/p\u003e\n\n\u003cp\u003eAfter this we can use Powerpill as a replacement of Pacman as follows\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"c1\"\u003e# System upgrade\u003c/span\u003e\nsudo powerpill -Syu\n\n\u003cspan class=\"c1\"\u003e# Install a package\u003c/span\u003e\nsudo powerpill -S wget\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"conclusions\"\u003eConclusions\u003c/h3\u003e\n\n\u003cp\u003eWhen \u003ca href=\"http://xyne.archlinux.ca/projects/powerpill/\u0026gt;\"\u003epowerpill\u003c/a\u003e is used..\u003c/p\u003e\n\n\u003ch3 id=\"todos\"\u003eTODOs\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eCheck how to have only *\u003cstrong\u003e\u003cem\u003eone\u003c/em\u003e\u003c/strong\u003e* Master DB and all the Slaves also sync the DB from the master\u003c/li\u003e\n\u003cli\u003eUse reflector commands within Powerpill\u003c/li\u003e\n\u003cli\u003eWhat happens if different architectures are on the same network and UDP multicast works?\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"troubleshooting-pacserve--without-powerpill\"\u003eTroubleshooting Pacserve (without Powerpill)\u003c/h3\u003e\n\n\u003cp\u003eAs I said before I could not make it working using multicast, so I had to\nmanually start the Pacserve Master host as:\u003c/p\u003e\n\n\u003cp\u003eInput:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003epacserve --multicast\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOutput:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003ePacserveServer\n  PID                  \u003cspan class=\"m\"\u003e1048\u003c/span\u003e\n  Addresses\n    lo:     \u003cspan class=\"m\"\u003e127\u003c/span\u003e.0.0.1\n    eth0:   \u003cspan class=\"m\"\u003e10\u003c/span\u003e.0.2.15\n    enp0s9: \u003cspan class=\"m\"\u003e192\u003c/span\u003e.168.56.6\n  Port                 \u003cspan class=\"m\"\u003e15678\u003c/span\u003e\n  Multicast Address    all interfaces\n  Multicast Port       \u003cspan class=\"m\"\u003e15679\u003c/span\u003e\n  Multicast Group      \u003cspan class=\"m\"\u003e224\u003c/span\u003e.3.45.67\n  Multicast Interval   5m\n  Multicast Interfaces all\n  Filelist             None\n  Filterlist           None\n  MOTD                 None\n  Upload Directory     None\n  Paths                None\n  Static Peers         None\n\nPress ctrl+C to exit.\n\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:54:54 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: announcing presence by multicast \u003cspan class=\"o\"\u003e(\u003c/span\u003egroup: \u003cspan class=\"m\"\u003e224\u003c/span\u003e.3.45.67\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:54:54 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: announcement sent via all interfaces\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAssuming the server is running with the IP \u003ccode\u003e192.168.56.6\u003c/code\u003e, you can manually\nstart Pacserve on the Slave(s) hosts as:\u003c/p\u003e\n\n\u003cp\u003eInput:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003epacserve --multicast --peer \u003cspan class=\"s2\"\u003e\u0026#34;http://192.168.56.6:15678\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOutput:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003ePacserveServer\n  PID                  \u003cspan class=\"m\"\u003e1102\u003c/span\u003e\n  Addresses\n    lo:     \u003cspan class=\"m\"\u003e127\u003c/span\u003e.0.0.1\n    eth0:   \u003cspan class=\"m\"\u003e10\u003c/span\u003e.0.2.15\n    enp0s9: \u003cspan class=\"m\"\u003e192\u003c/span\u003e.168.56.7\n  Port                 \u003cspan class=\"m\"\u003e15678\u003c/span\u003e\n  Multicast Address    all interfaces\n  Multicast Port       \u003cspan class=\"m\"\u003e15679\u003c/span\u003e\n  Multicast Group      \u003cspan class=\"m\"\u003e224\u003c/span\u003e.3.45.67\n  Multicast Interval   5m\n  Multicast Interfaces all\n  Filelist             None\n  Filterlist           None\n  MOTD                 None\n  Upload Directory     None\n  Paths                None\n  Static Peers         http://192.168.56.6:15678\n\nPress ctrl+C to exit.\n\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:56:00 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: announcing presence via POST to http://192.168.56.6:15678\n\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:56:00 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: POSTing to http://192.168.56.6:15678/ \u003cspan class=\"o\"\u003e[\u003c/span\u003etype: nudge\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:56:01 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: announcing presence by multicast \u003cspan class=\"o\"\u003e(\u003c/span\u003egroup: \u003cspan class=\"m\"\u003e224\u003c/span\u003e.3.45.67\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:56:01 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: announcement sent via all interfaces\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter starting the Slave host you should get the following message on the Master console:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:56:00 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: added http://192.168.56.7:15678/ \u003cspan class=\"o\"\u003e(\u003c/span\u003ePOST\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2015\u003c/span\u003e-10-23 \u003cspan class=\"m\"\u003e05\u003c/span\u003e:56:00 AEDT\u003cspan class=\"o\"\u003e]\u003c/span\u003e INFO: \u003cspan class=\"m\"\u003e192\u003c/span\u003e.168.56.7 \u003cspan class=\"s2\"\u003e\u0026#34;POST / HTTP/1.1\u0026#34;\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e -\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","text":" On this post I will show how to configure and use Pacserve and Powerpill on Arch Linux. On a network of several Arch Linux boxes, it is possible to configure a Master server which will hold a copy of all the installed packages within that host and keep it up to date frequently. The other hosts on the network can be configured as Slaves and they will download the packages from the Master whenever possible instead of the Internet directly. The objective is to save bandwidth and time when using the package manager.\nConfiguring Pacserve and Powerpill on Arch Linux The documentation of Pacserve explains how it works. This image summarizes well the behavior.\n  Pacserve by itself seems very interesting however I could not make it work properly. I think it has something to do my router UDP multicast forwarding support (see openwrt-multicast). Nevertheless, I could use it within Powerpill which is a pacman wrapper to allow parallel and segmented downloads through Aria2 and Reflector. This combo sounds even better, so I will focus on how to install and use the tree tools together.\nInstallation # Just in case the testdb does not exists gpg --list-key # Receive xyne gpg key gpg --recv-keys 1D1F0DC78F173680 # Install the packages yaourt -Sy --noconfirm reflector pacserve powerpill Starting the services (both the Master and Slave(s) host(s)) After everything is installed:\n# Enable opening the ports sudo systemctl enable pacserve-ports.service # Enable pacserve sudo systemctl enable pacserve.service # Start pacserve sudo systemctl start pacserve.service For troubleshooting purposes the services can be started manually. See the Troubleshooting section if you have problems.\nConfiguring Powerpill to use the Master server (Slave(s) hosts only) Edit the file /etc/powerpill/powerpill.json to include the `pacserve`.`serve` attribute:\n{ \u0026#34;aria2\u0026#34;: { \u0026#34;args\u0026#34;: [ \u0026#34;--allow-overwrite=true\u0026#34;, \u0026#34;--always-resume=false\u0026#34;, \u0026#34;--auto-file-renaming=false\u0026#34;, \u0026#34;--check-integrity=true\u0026#34;, \u0026#34;--conditional-get=true\u0026#34;, \u0026#34;--continue=true\u0026#34;, \u0026#34;--file-allocation=none\u0026#34;, \u0026#34;--log-level=error\u0026#34;, \u0026#34;--max-concurrent-downloads=100\u0026#34;, \u0026#34;--max-connection-per-server=5\u0026#34;, \u0026#34;--min-split-size=5M\u0026#34;, \u0026#34;--remote-time=true\u0026#34;, \u0026#34;--show-console-readout=true\u0026#34; ], \u0026#34;path\u0026#34;: \u0026#34;/usr/bin/aria2c\u0026#34; }, \u0026#34;pacman\u0026#34;: { \u0026#34;config\u0026#34;: \u0026#34;/etc/pacman.conf\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/usr/bin/pacman\u0026#34; }, \u0026#34;pacserve\u0026#34;: { \u0026#34;server\u0026#34;: \u0026#34;http://192.168.56.6:15678\u0026#34; }, \u0026#34;powerpill\u0026#34;: { \u0026#34;ask\u0026#34;: true, \u0026#34;reflect databases\u0026#34;: false }, \u0026#34;reflector\u0026#34;: { \u0026#34;args.unused\u0026#34;: [ \u0026#34;--protocol\u0026#34;, \u0026#34;http\u0026#34;, \u0026#34;--latest\u0026#34;, \u0026#34;50\u0026#34; ] }, \u0026#34;rsync\u0026#34;: { \u0026#34;args\u0026#34;: [ \u0026#34;--no-motd\u0026#34;, \u0026#34;--progress\u0026#34; ], \u0026#34;db only\u0026#34;: true, \u0026#34;path\u0026#34;: \u0026#34;/usr/bin/rsync\u0026#34;, \u0026#34;servers\u0026#34;: [] } } In this example I configured two VMs using Vagrant with an internal network. The server runs on 192.168.56.6 on port `15678` (default port).\nAfter this we can use Powerpill as a replacement of Pacman as follows\n# System upgrade sudo powerpill -Syu # Install a package sudo powerpill -S wget Conclusions When powerpill is used..\nTODOs  Check how to have only *one* Master DB and all the Slaves also sync the DB from the master Use reflector commands within Powerpill What happens if different architectures are on the same network and UDP multicast works?  Troubleshooting Pacserve (without Powerpill) As I said before I could not make it working using multicast, so I had to manually start the Pacserve Master host as:\nInput:\npacserve --multicast Output:\nPacserveServer PID 1048 Addresses lo: 127.0.0.1 eth0: 10.0.2.15 enp0s9: 192.168.56.6 Port 15678 Multicast Address all interfaces Multicast Port 15679 Multicast Group 224.3.45.67 Multicast Interval 5m Multicast Interfaces all Filelist None Filterlist None MOTD None Upload Directory None Paths None Static Peers None Press ctrl+C to exit. [2015-10-23 05:54:54 AEDT] INFO: announcing presence by multicast (group: 224.3.45.67) [2015-10-23 05:54:54 AEDT] INFO: announcement sent via all interfaces Assuming the server is running with the IP 192.168.56.6, you can manually start Pacserve on the Slave(s) hosts as:\nInput:\npacserve --multicast --peer \u0026#34;http://192.168.56.6:15678\u0026#34; Output:\nPacserveServer PID 1102 Addresses lo: 127.0.0.1 eth0: 10.0.2.15 enp0s9: 192.168.56.7 Port 15678 Multicast Address all interfaces Multicast Port 15679 Multicast Group 224.3.45.67 Multicast Interval 5m Multicast Interfaces all Filelist None Filterlist None MOTD None Upload Directory None Paths None Static Peers http://192.168.56.6:15678 Press ctrl+C to exit. [2015-10-23 05:56:00 AEDT] INFO: announcing presence via POST to http://192.168.56.6:15678 [2015-10-23 05:56:00 AEDT] INFO: POSTing to http://192.168.56.6:15678/ [type: nudge] [2015-10-23 05:56:01 AEDT] INFO: announcing presence by multicast (group: 224.3.45.67) [2015-10-23 05:56:01 AEDT] INFO: announcement sent via all interfaces After starting the Slave host you should get the following message on the Master console:\n[2015-10-23 05:56:00 AEDT] INFO: added http://192.168.56.7:15678/ (POST) [2015-10-23 05:56:00 AEDT] INFO: 192.168.56.7 \u0026#34;POST / HTTP/1.1\u0026#34; 200 -"},"name":"Configuring pacsrv and powerpill on Arch Linux","published":"2015-10-21T00:00:00-02:00","summary":"On this post I will show how to configure and use Pacserve and Powerpill on Arch Linux. On a network of several Arch Linux boxes, it is possible to configure a Master server which will hold a copy of all the installed packages within that host and keep it up to date frequently. The other hosts on the network can be configured as Slaves and they will download the packages from the Master whenever possible instead of the Internet directly.","type":"entry","url":"https://albertdelafuente.com/posts/20220109211826-configuring_pacsrv_and_powerpill_on_arch_linux/"}],"name":"archlinux","type":"feed","url":"https://albertdelafuente.com/tags/archlinux/"}